generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- BETTER-AUTH & USER MODELS ---


/*

USE DEFAULT USER MODEL AND CREATE CUSTOM ATTRIBUTES AND RELATIONS BASED ON IT

*/


model User {
  id            String    @id
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Přidané atributy z původního modelu users
  username      String    @unique
  phone_number  String?   @unique
  role          Int?      @default(3)

  // Vazby
  sessions      Session[]
  accounts      Account[]
  
  // Vazby na ticket systém (přejmenováno pro lepší čitelnost)
  tickets_processed ticket[]            @relation("ticket_processing_user")
  tickets_reported  ticket[]            @relation("ticket_reported_user")
  attachments       ticket_attachment[]
  
  // Vazba na roli
  role_ref          role?               @relation(fields: [role], references: [role_id], onDelete: NoAction, onUpdate: NoAction)

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

// --- TICKET SYSTEM MODELS ---

model ticket {
  ticket_id           Int       @id @default(autoincrement())
  ticket_title        String    @db.VarChar(255)
  created_time        DateTime  @default(now()) @db.Timestamptz(6)
  updated_status      DateTime? @db.Timestamp(6)
  solved_at           DateTime? @db.Timestamp(6)
  
  // Cizí klíče změněny na String kvůli vazbě na nový model User
  reported_user       String    
  processing_user     String?
  
  room                Int
  category            Int
  description         Int
  priority            Int
  status              Int       @default(1)
  ticket_attachment   Int?

  // Relace
  user_reported       User      @relation("ticket_reported_user", fields: [reported_user], references: [id], onDelete: NoAction, onUpdate: NoAction)
  user_processing     User?     @relation("ticket_processing_user", fields: [processing_user], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  category_ref        category  @relation(fields: [category], references: [category_id], onDelete: NoAction, onUpdate: NoAction)
  description_ref     description @relation(fields: [description], references: [description_id], onDelete: NoAction, onUpdate: NoAction)
  priority_ref        priority  @relation(fields: [priority], references: [priority_id], onDelete: NoAction, onUpdate: NoAction)
  room_ref            room      @relation(fields: [room], references: [room_id], onDelete: NoAction, onUpdate: NoAction)
  status_ref          status    @relation(fields: [status], references: [status_id], onDelete: NoAction, onUpdate: NoAction)
  attachment_ref      ticket_attachment? @relation("ticket_to_attachment", fields: [ticket_attachment], references: [attachment_id], onDelete: NoAction, onUpdate: NoAction)
}

model ticket_attachment {
  attachment_id   Int      @id @default(autoincrement())
  url             String
  uploaded_by     String?  // Změněno na String
  
  tickets         ticket[] @relation("ticket_to_attachment")
  user_uploaded   User?    @relation(fields: [uploaded_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model role {
  role_id   Int     @id @default(autoincrement())
  role_name String  @db.VarChar(255)
  users     User[]  // Vazba na nový model User
}

// Ostatní číselníkové modely zůstávají stejné, jen pro přehlednost:

model category {
  category_id   Int      @id @default(autoincrement())
  category_name String   @unique @db.VarChar
  tickets       ticket[]
}

model description {
  description_id Int      @id @default(autoincrement())
  description    String
  tickets        ticket[]
}

model floor {
  floor_id   Int    @id @default(autoincrement())
  floor_name String @db.VarChar(255)
  rooms      room[]
}

model priority {
  priority_id   Int      @id @default(autoincrement())
  priority_type String   @unique @db.VarChar(255)
  tickets       ticket[]
}

model room {
  room_id   Int    @id @default(autoincrement())
  name      String @unique @db.VarChar
  floor     Int
  room_type Int
  floor_ref floor  @relation(fields: [floor], references: [floor_id], onDelete: NoAction, onUpdate: NoAction)
  type_ref  room_type @relation(fields: [room_type], references: [room_type_id], onDelete: NoAction, onUpdate: NoAction)
  tickets   ticket[]
}

model room_type {
  room_type_id   Int    @id @default(autoincrement())
  room_type_name String @db.VarChar(255)
  rooms          room[]
}

model status {
  status_id   Int      @id @default(autoincrement())
  status_name String   @unique @db.VarChar(255)
  tickets     ticket[]
}